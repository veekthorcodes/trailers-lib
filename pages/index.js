import Head from "next/head";
import { useEffect, useState } from "react";
import { useRouter } from "next/router";

import Banner from "@components/banner/Banner";
import Navbar from "@components/navbar/Navbar";
import CardSection from "@components/card/CardSection";
import LoadingSpinner from "@components/utils/LoadingSpinner";
import { getPopularVideos, getVideos } from "@utils/videos";
import { queryHasuraGQL } from "@utils/db/hasura";
import styles from "@styles/Home.module.css";

export const getServerSideProps = async () => {
  const DisneyVideos = await getVideos("Disney");
  const MarvelVideos = await getVideos("Marvel");
  const ProductivityVideos = await getVideos("Productiviy");
  const PopularVideos = await getPopularVideos("US");

  return {
    props: { DisneyVideos, MarvelVideos, ProductivityVideos, PopularVideos },
  };
};

export default function Home({
  DisneyVideos,
  MarvelVideos,
  ProductivityVideos,
  PopularVideos,
}) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  useEffect(() => {
    const handleRouteChange = () => {
      setLoading(true);
    };
    const handleRouteComplete = () => {
      setLoading(false);
    };

    router.events.on("routeChangeStart", handleRouteChange);
    router.events.on("routeChangeComplete", handleRouteComplete);

    return () => {
      router.events.off("routeChangeStart", handleRouteChange);
      router.events.off("routeChangeComplete", handleRouteComplete);
    };
  }, []);

  queryHasuraGQL();

  return (
    <div>
      <Head>
        <title>Next Flix</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      {loading && <LoadingSpinner />}
      <Navbar user="codes@company.com" />
      <Banner
        videoId="Yj0l7iGKh8g"
        title="The Flash"
        subTitle="The fastest man alive"
        imgUrl="/static/theflashcover.jpg"
      />
      <div className={styles.sectionWrapper}>
        <CardSection title="Marvel" videos={MarvelVideos} size="small" />
        <CardSection title="Disney" videos={DisneyVideos} size="medium" />
        <CardSection
          title="Productivity"
          videos={ProductivityVideos}
          size="large"
        />
        <CardSection title="Popular" videos={PopularVideos} size="small" />
      </div>
    </div>
  );
}
